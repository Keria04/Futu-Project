# æµ®å›¾å›¾åƒæœç´¢ç³»ç»Ÿ - é‡æ„ç‰ˆ

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
å‰ç«¯ â†’ æ§åˆ¶ç«¯(Flask) â†’ Redisä»»åŠ¡é˜Ÿåˆ— â†’ è®¡ç®—ç«¯(Worker)
  â†‘                    â†“
  â””â”€â”€â”€â”€ Faissç´¢å¼• â†â”€â”€â”€â”€â”€â”˜
```

### è®¾è®¡æ¨¡å¼åº”ç”¨

- **å•ä¾‹æ¨¡å¼**: Rediså®¢æˆ·ç«¯ã€ä»»åŠ¡ç®¡ç†å™¨ã€æ•°æ®åº“æœåŠ¡
- **å·¥å‚æ¨¡å¼**: æœç´¢ç­–ç•¥å·¥å‚ã€åº”ç”¨å·¥å‚
- **ç­–ç•¥æ¨¡å¼**: æœç´¢ç­–ç•¥ã€ä»»åŠ¡åˆ†å‘ç­–ç•¥ã€ä»»åŠ¡å¤„ç†å™¨
- **è§‚å¯Ÿè€…æ¨¡å¼**: ä»»åŠ¡ç›‘æ§ã€ç´¢å¼•æ„å»ºè¿›åº¦é€šçŸ¥
- **å»ºé€ è€…æ¨¡å¼**: ç´¢å¼•æ„å»ºå™¨
- **ä»£ç†æ¨¡å¼**: æ•°æ®åº“æœåŠ¡ä»£ç†

## ğŸ“ æ–°ç›®å½•ç»“æ„

```
backend/
â”œâ”€â”€ control_service/          # æ§åˆ¶ç«¯
â”‚   â”œâ”€â”€ app.py               # Flaskä¸»åº”ç”¨
â”‚   â”œâ”€â”€ config.py            # æ§åˆ¶ç«¯é…ç½®
â”‚   â”œâ”€â”€ api/                 # APIè·¯ç”±å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ search_api.py    # æœç´¢API
â”‚   â”‚   â”œâ”€â”€ index_api.py     # ç´¢å¼•API
â”‚   â”‚   â”œâ”€â”€ dataset_api.py   # æ•°æ®é›†API
â”‚   â”‚   â””â”€â”€ image_api.py     # å›¾ç‰‡API
â”‚   â”œâ”€â”€ services/            # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ search_service.py    # æœç´¢æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ index_service.py     # ç´¢å¼•æœåŠ¡
â”‚   â”‚   â””â”€â”€ database_service.py  # æ•°æ®åº“æœåŠ¡
â”‚   â””â”€â”€ faiss_module/        # Faissæ¨¡å—ï¼ˆä¸å¯ä¿®æ”¹ï¼‰
â”œâ”€â”€ compute_service/         # è®¡ç®—ç«¯
â”‚   â”œâ”€â”€ worker.py            # è®¡ç®—å·¥ä½œèŠ‚ç‚¹
â”‚   â”œâ”€â”€ config.py            # è®¡ç®—ç«¯é…ç½®
â”‚   â””â”€â”€ model_module/        # Modelæ¨¡å—ï¼ˆä¸å¯ä¿®æ”¹ï¼‰
â”œâ”€â”€ shared/                  # å…±äº«ç»„ä»¶
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ redis_client.py      # Rediså®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ task_manager.py      # ä»»åŠ¡ç®¡ç†å™¨
â”‚   â””â”€â”€ message_protocol.py  # æ¶ˆæ¯åè®®
â”œâ”€â”€ start.py                 # ç»Ÿä¸€å¯åŠ¨è„šæœ¬
â”œâ”€â”€ database_module/         # åŸæ•°æ®åº“æ¨¡å—ï¼ˆä¿ç•™ï¼‰
â”œâ”€â”€ index_manage_module/     # åŸç´¢å¼•ç®¡ç†æ¨¡å—ï¼ˆä¿ç•™ï¼‰
â””â”€â”€ search_module/           # åŸæœç´¢æ¨¡å—ï¼ˆä¿ç•™ï¼‰
```

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirement.txt
```

### 2. å¯åŠ¨RedisæœåŠ¡

Windows:
```bash
# ä¸‹è½½å¹¶å¯åŠ¨Redis for Windows
redis-server
```

Linux/Mac:
```bash
redis-server
```

### 3. å¯åŠ¨ç³»ç»Ÿ

```bash
cd backend
python start.py
```

æˆ–è€…åˆ†åˆ«å¯åŠ¨ï¼š

```bash
# å¯åŠ¨æ§åˆ¶ç«¯
cd backend/control_service
python app.py

# å¯åŠ¨è®¡ç®—ç«¯ï¼ˆæ–°ç»ˆç«¯ï¼‰
cd backend/compute_service  
python worker.py
```

## ğŸ“Š ç³»ç»Ÿç‰¹æ€§

### æ§åˆ¶ç«¯ç‰¹æ€§
- **å¼‚æ­¥ä»»åŠ¡ç®¡ç†**: åŸºäºRedisçš„ä»»åŠ¡é˜Ÿåˆ—
- **RESTful API**: å®Œæ•´çš„REST APIæ¥å£
- **ç´¢å¼•ç®¡ç†**: åˆ†å¸ƒå¼ç´¢å¼•æ„å»ºå’Œç®¡ç†
- **æœç´¢æœåŠ¡**: æ”¯æŒå•å›¾æœç´¢å’Œé‡å¤å›¾æœç´¢
- **è¿›åº¦ç›‘æ§**: å®æ—¶ä»»åŠ¡è¿›åº¦è¿½è¸ª

### è®¡ç®—ç«¯ç‰¹æ€§
- **å¯æ‰©å±•æ€§**: æ”¯æŒå¤šä¸ªè®¡ç®—å·¥ä½œèŠ‚ç‚¹
- **ä»»åŠ¡å¤„ç†**: å›¾åƒç‰¹å¾æå–å’Œæ‰¹å¤„ç†
- **å®¹é”™æœºåˆ¶**: ä»»åŠ¡å¤±è´¥é‡è¯•å’Œé”™è¯¯å¤„ç†
- **èµ„æºç®¡ç†**: æ¨¡å‹æ‡’åŠ è½½å’Œå†…å­˜ç®¡ç†

### å…±äº«ç»„ä»¶ç‰¹æ€§
- **æ¶ˆæ¯åè®®**: æ ‡å‡†åŒ–çš„ä»»åŠ¡å’Œç»“æœæ ¼å¼
- **Redisé›†æˆ**: é«˜æ€§èƒ½çš„ä»»åŠ¡é˜Ÿåˆ—å’Œç¼“å­˜
- **è§‚å¯Ÿè€…æ¨¡å¼**: çµæ´»çš„äº‹ä»¶é€šçŸ¥æœºåˆ¶

## ğŸ”§ APIæ¥å£

### æœç´¢ç›¸å…³
- `POST /api/search` - å›¾åƒæœç´¢
- `POST /api/repeated_search` - é‡å¤å›¾åƒæœç´¢

### ç´¢å¼•ç›¸å…³
- `POST /api/build_index` - æ„å»ºç´¢å¼•
- `GET /api/build_index/progress/<dataset_name>` - è·å–æ„å»ºè¿›åº¦
- `GET /api/build_index/status/<dataset_name>` - è·å–æ„å»ºçŠ¶æ€

### æ•°æ®é›†ç›¸å…³
- `GET /api/datasets` - è·å–æ‰€æœ‰æ•°æ®é›†
- `GET /api/dataset/<dataset_name>/id` - è·å–æ•°æ®é›†ID
- `GET /api/dataset/<dataset_name>/images` - è·å–æ•°æ®é›†å›¾ç‰‡

### å›¾ç‰‡ç›¸å…³
- `GET /api/image/<filename>` - è·å–å›¾ç‰‡æ–‡ä»¶
- `POST /api/upload` - ä¸Šä¼ å›¾ç‰‡

## ğŸ§ª å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„ä»»åŠ¡ç±»å‹

1. åœ¨ `shared/message_protocol.py` ä¸­æ·»åŠ æ–°çš„ `TaskType`
2. åœ¨ `compute_service/worker.py` ä¸­åˆ›å»ºå¯¹åº”çš„ `TaskProcessor`
3. åœ¨æ§åˆ¶ç«¯æœåŠ¡ä¸­æ·»åŠ æäº¤ä»»åŠ¡çš„æ–¹æ³•

### æ‰©å±•æœç´¢ç­–ç•¥

1. åœ¨ `control_service/services/search_service.py` ä¸­å®ç°æ–°çš„ `SearchStrategy`
2. åœ¨ `SearchServiceFactory` ä¸­æ³¨å†Œæ–°ç­–ç•¥

### æ·»åŠ æ–°çš„APIæ¥å£

1. åœ¨ `control_service/api/` ä¸­åˆ›å»ºæ–°çš„APIæ¨¡å—
2. åœ¨å¯¹åº”çš„æœåŠ¡å±‚ä¸­å®ç°ä¸šåŠ¡é€»è¾‘
3. åœ¨ `control_service/app.py` ä¸­æ³¨å†Œæ–°çš„è“å›¾

## ğŸ”„ è¿ç§»è¯´æ˜

åŸæœ‰çš„ `faiss_module` å’Œ `model_module` å·²æŒ‰è¦æ±‚ç§»åŠ¨åˆ°å¯¹åº”ä½ç½®ï¼š
- `faiss_module` â†’ `control_service/faiss_module`
- `model_module` â†’ `compute_service/model_module`

åŸæœ‰çš„å…¶ä»–æ¨¡å—ï¼ˆ`database_module`ã€`route`ã€`search_module` ç­‰ï¼‰å·²é‡æ„ä¸ºæ–°çš„æœåŠ¡å±‚æ¶æ„ã€‚

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

- **è¿æ¥æ± **: Redisè¿æ¥æ± ç®¡ç†
- **æ‰¹å¤„ç†**: æ”¯æŒæ‰¹é‡ç‰¹å¾æå–
- **ç¼“å­˜**: ä»»åŠ¡ç»“æœç¼“å­˜
- **å¹¶å‘**: å¤šçº¿ç¨‹ä»»åŠ¡å¤„ç†
- **ç´¢å¼•ä¼˜åŒ–**: Faiss IVFç´¢å¼•ä¼˜åŒ–

## ğŸ› ï¸ æ•…éšœæ’é™¤

### Redisè¿æ¥é—®é¢˜
ç¡®ä¿RedisæœåŠ¡æ­£åœ¨è¿è¡Œï¼š
```bash
redis-cli ping
```

### è®¡ç®—ç«¯æ— æ³•å¯åŠ¨
æ£€æŸ¥æ¨¡å‹ä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…ï¼š
```bash
python -c "import torch; print(torch.__version__)"
```

### å†…å­˜ä¸è¶³
è°ƒæ•´æ‰¹å¤„ç†å¤§å°ï¼š
```python
# åœ¨ config/config.py ä¸­
batchsize = 32  # å‡å°æ‰¹å¤„ç†å¤§å°
```
