# å›¾ç‰‡æœç´¢åŠŸèƒ½é‡å†™æŠ¥å‘Š

## ğŸ“‹ é‡å†™æ¦‚è¿°

æˆ‘å·²ç»å®Œå…¨é‡å†™äº†å›¾ç‰‡æœç´¢åŠŸèƒ½ï¼Œä½¿ç”¨ç´¢å¼•æ¥å£æ¥æŸ¥æ‰¾å¯¹åº”æ•°æ®é›†çš„FAISSç´¢å¼•ï¼Œå®ç°äº†çœŸæ­£çš„å›¾ç‰‡ç›¸ä¼¼åº¦æœç´¢ã€‚

## ğŸ”§ ä¸»è¦æ”¹è¿›

### 1. çœŸå®çš„FAISSç´¢å¼•æœç´¢
- **åŸæ¥**: è¿”å›ç¡¬ç¼–ç çš„æ¨¡æ‹Ÿç»“æœ
- **ç°åœ¨**: ä½¿ç”¨`_index_interface`è°ƒç”¨çœŸå®çš„FAISSç´¢å¼•è¿›è¡Œæœç´¢

### 2. å®Œæ•´çš„æœç´¢æµç¨‹
```
ä¸Šä¼ å›¾ç‰‡ â†’ å›¾ç‰‡é¢„å¤„ç† â†’ ç‰¹å¾æå– â†’ ç´¢å¼•æœç´¢ â†’ ç»“æœå¤„ç† â†’ è¿”å›ç»“æœ
```

### 3. æ”¯æŒçš„åŠŸèƒ½
- âœ… å¤šæ•°æ®é›†æœç´¢
- âœ… å›¾ç‰‡è£å‰ªæ”¯æŒ
- âœ… ç›¸ä¼¼åº¦é˜ˆå€¼è¿‡æ»¤
- âœ… ç»“æœæ•°é‡é™åˆ¶ (top_k)
- âœ… è¯¦ç»†çš„æœç´¢å‚æ•°
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. å›¾ç‰‡ç‰¹å¾æå–
```python
def _extract_image_features(image_path: str) -> np.ndarray:
    """é€šè¿‡Redisè°ƒç”¨è®¡ç®—ç«¯æå–å›¾ç‰‡ç‰¹å¾å‘é‡"""
    redis_client = get_redis_client()
    task_data = {'task_type': 'feature_extraction', 'image_path': image_path}
    task_id = redis_client.publish_task('compute:feature_extraction', task_data)
    result = redis_client.get_result(task_id, timeout=30)
    return np.array(result['features'], dtype=np.float32)
```

### 2. ç´¢å¼•æœç´¢
```python
def _search_dataset_index(dataset_id, dataset_name, query_features, top_k, threshold):
    """ä½¿ç”¨ç´¢å¼•æ¥å£æœç´¢æŒ‡å®šæ•°æ®é›†"""
    index_manager = get_index_manager()
    indexer = index_manager.get_indexer(vector_dim=query_features.shape[0])
    results, similarities = indexer.search_index(query_features, [f"{dataset_id}.index"], top_k)
    return processed_results
```

### 3. å›¾ç‰‡è£å‰ª
```python
def _crop_image(image_path: str, x: int, y: int, w: int, h: int) -> str:
    """ä½¿ç”¨PILè¿›è¡Œå›¾ç‰‡è£å‰ª"""
    with Image.open(image_path) as img:
        cropped_img = img.crop((x, y, x + w, y + h))
        cropped_img.save(cropped_path, 'JPEG')
    return cropped_path
```

## ğŸ“Š APIæ¥å£æ ¼å¼

### è¯·æ±‚æ ¼å¼
```http
POST /api/search
Content-Type: multipart/form-data

query_img: [å›¾ç‰‡æ–‡ä»¶]
dataset_names[]: ["1", "2"]  # æ•°æ®é›†åç§°æ•°ç»„
top_k: 10                    # è¿”å›ç»“æœæ•°é‡
similarity_threshold: 50.0   # ç›¸ä¼¼åº¦é˜ˆå€¼
crop_x: 0                    # è£å‰ªåŒºåŸŸxåæ ‡
crop_y: 0                    # è£å‰ªåŒºåŸŸyåæ ‡  
crop_w: 0                    # è£å‰ªåŒºåŸŸå®½åº¦
crop_h: 0                    # è£å‰ªåŒºåŸŸé«˜åº¦
```

### å“åº”æ ¼å¼
```json
{
  "success": true,
  "results": [
    {
      "image_id": 123,
      "image_path": "/path/to/image.jpg",
      "img_url": "/show_image/datasets/1/image.jpg",
      "fname": "image.jpg",
      "similarity": 95.67,
      "distance": 0.0433,
      "dataset": "dataset1",
      "dataset_id": 1,
      "rank": 1,
      "file_size": 156789,
      "created_at": "2025-06-25T10:00:00"
    }
  ],
  "total_found": 5,
  "search_params": {
    "crop_region": {"x": 0, "y": 0, "width": 100, "height": 100},
    "datasets": ["1", "2"],
    "top_k": 10,
    "similarity_threshold": 50.0
  },
  "query_info": {
    "original_filename": "query.jpg",
    "query_time": "2025-06-25T15:44:36"
  }
}
```

## ğŸ”— æ¶æ„é›†æˆ

### 1. ä¸ç´¢å¼•æ¥å£é›†æˆ
- ä½¿ç”¨ `_index_interface.py` ä¸­çš„ `IndexManager`
- æ”¯æŒä¸åŒçš„ç´¢å¼•ç­–ç•¥ (IVF, Flat, HNSW)
- è‡ªåŠ¨ç®¡ç†ç´¢å¼•å™¨ç¼“å­˜

### 2. ä¸æ•°æ®åº“æ¥å£é›†æˆ
- ä½¿ç”¨ `_database_interface.py` è·å–æ•°æ®é›†å’Œå›¾ç‰‡ä¿¡æ¯
- è‡ªåŠ¨è¡¥å……æœç´¢ç»“æœçš„è¯¦ç»†ä¿¡æ¯

### 3. ä¸è®¡ç®—ç«¯é›†æˆ
- é€šè¿‡Redisä»»åŠ¡é˜Ÿåˆ—è°ƒç”¨ç‰¹å¾æå–æœåŠ¡
- æ”¯æŒå¼‚æ­¥ç‰¹å¾æå–æ“ä½œ

## ğŸ› ï¸ æŠ€æœ¯ç‰¹æ€§

### 1. ç›¸ä¼¼åº¦è®¡ç®—
- å°†FAISSè·ç¦»è½¬æ¢ä¸ºç™¾åˆ†æ¯”ç›¸ä¼¼åº¦
- æ”¯æŒç›¸ä¼¼åº¦é˜ˆå€¼è¿‡æ»¤
- è·ç¦»è¶Šå°ç›¸ä¼¼åº¦è¶Šé«˜

### 2. ç»“æœæ’åºå’Œé™åˆ¶
- æŒ‰ç›¸ä¼¼åº¦é™åºæ’åº
- æ”¯æŒtop_ké™åˆ¶ç»“æœæ•°é‡
- å¤šæ•°æ®é›†ç»“æœåˆå¹¶

### 3. é”™è¯¯å¤„ç†
- å®Œå–„çš„å¼‚å¸¸æ•è·å’Œæ—¥å¿—è®°å½•
- ä¼˜é›…çš„é™çº§å¤„ç†
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯è¿”å›

### 4. èµ„æºç®¡ç†
- è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶
- Redisä»»åŠ¡ç»“æœæ¸…ç†
- å†…å­˜é«˜æ•ˆçš„ç‰¹å¾å¤„ç†

## ğŸ§ª æµ‹è¯•å»ºè®®

ä½¿ç”¨æä¾›çš„æµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š

```bash
# è¿è¡Œæœç´¢åŠŸèƒ½æµ‹è¯•
python test_search_function.py
```

æµ‹è¯•å†…å®¹åŒ…æ‹¬ï¼š
- åç«¯æœåŠ¡çŠ¶æ€æ£€æŸ¥
- å‚æ•°éªŒè¯æµ‹è¯•
- å®é™…å›¾ç‰‡æœç´¢æµ‹è¯•
- è£å‰ªåŠŸèƒ½æµ‹è¯•

## ğŸ“ˆ æ€§èƒ½è€ƒè™‘

### 1. ç´¢å¼•å™¨ç¼“å­˜
- ä½¿ç”¨ `IndexManager` ç¼“å­˜ç´¢å¼•å™¨å®ä¾‹
- é¿å…é‡å¤åˆ›å»ºç´¢å¼•å™¨å¯¹è±¡

### 2. ç‰¹å¾æå–ä¼˜åŒ–
- æ”¯æŒæ‰¹é‡ç‰¹å¾æå–ï¼ˆæ‰©å±•ç‚¹ï¼‰
- å¼‚æ­¥å¤„ç†é¿å…é˜»å¡

### 3. æœç´¢ä¼˜åŒ–
- å¹¶è¡Œæœç´¢å¤šä¸ªæ•°æ®é›†ï¼ˆå¯æ‰©å±•ï¼‰
- æ™ºèƒ½çš„ç›¸ä¼¼åº¦é˜ˆå€¼è¿‡æ»¤

## ğŸ”§ é…ç½®è¯´æ˜

æœç´¢åŠŸèƒ½ä¾èµ–ä»¥ä¸‹æœåŠ¡ï¼š
1. **åç«¯æœåŠ¡**: Flaskåº”ç”¨ (ç«¯å£5000)
2. **RedisæœåŠ¡**: ä»»åŠ¡é˜Ÿåˆ—é€šä¿¡
3. **è®¡ç®—ç«¯æœåŠ¡**: ç‰¹å¾æå–æœåŠ¡
4. **FAISSç´¢å¼•**: é¢„æ„å»ºçš„ç´¢å¼•æ–‡ä»¶

ç¡®ä¿æ‰€æœ‰ä¾èµ–æœåŠ¡æ­£å¸¸è¿è¡Œåï¼Œæœç´¢åŠŸèƒ½å³å¯æ­£å¸¸å·¥ä½œã€‚

## ğŸš€ ä½¿ç”¨æ–¹æ³•

1. **å¯åŠ¨æ‰€æœ‰æœåŠ¡**
```bash
# å¯åŠ¨Redis (å¦‚æœæ²¡æœ‰è¿è¡Œ)
redis-server

# å¯åŠ¨è®¡ç®—ç«¯æœåŠ¡
cd compute_server && python compute_server.py

# å¯åŠ¨åç«¯æœåŠ¡
cd backend_new && python run.py
```

2. **æ„å»ºç´¢å¼•** (å¦‚æœè¿˜æ²¡æœ‰)
   - ä½¿ç”¨å‰ç«¯ç•Œé¢æˆ–APIæ„å»ºæ•°æ®é›†ç´¢å¼•

3. **æµ‹è¯•æœç´¢åŠŸèƒ½**
```bash
python test_search_function.py
```

ç°åœ¨å›¾ç‰‡æœç´¢åŠŸèƒ½å·²ç»å®Œå…¨é‡å†™ï¼Œæ”¯æŒçœŸå®çš„FAISSç´¢å¼•æœç´¢ï¼ğŸ‰
