# å›¾ç‰‡æœç´¢åŠŸèƒ½ä½¿ç”¨è¯´æ˜

## ğŸ‰ é‡å†™å®Œæˆ

æˆ‘å·²ç»å®Œå…¨é‡å†™äº†å›¾ç‰‡æœç´¢åŠŸèƒ½ï¼Œç°åœ¨ä½¿ç”¨çœŸå®çš„FAISSç´¢å¼•è¿›è¡Œå›¾ç‰‡ç›¸ä¼¼åº¦æœç´¢ã€‚

## âœ… éªŒè¯ç»“æœ

æ‰€æœ‰æ£€æŸ¥éƒ½å·²é€šè¿‡ï¼š
- âœ… å¯¼å…¥ä¾èµ–æ­£ç¡®
- âœ… ä¸»è¦å‡½æ•°å®Œæ•´
- âœ… APIç»“æ„æ­£ç¡®
- âœ… ä¾èµ–æ–‡ä»¶å­˜åœ¨
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… å“åº”æ ¼å¼æ ‡å‡†

## ğŸ”§ ä¸»è¦åŠŸèƒ½

### 1. çœŸå®çš„FAISSç´¢å¼•æœç´¢
- ä½¿ç”¨ `_index_interface.py` è°ƒç”¨FAISSç´¢å¼•
- æ”¯æŒå¤šæ•°æ®é›†å¹¶è¡Œæœç´¢
- åŸºäºç‰¹å¾å‘é‡çš„ç›¸ä¼¼åº¦è®¡ç®—

### 2. å®Œæ•´çš„å›¾ç‰‡å¤„ç†æµç¨‹
```
ä¸Šä¼ å›¾ç‰‡ â†’ å›¾ç‰‡è£å‰ª(å¯é€‰) â†’ ç‰¹å¾æå– â†’ ç´¢å¼•æœç´¢ â†’ ç»“æœæ’åº â†’ è¿”å›ç»“æœ
```

### 3. é«˜çº§æœç´¢å‚æ•°
- **top_k**: è¿”å›ç»“æœæ•°é‡é™åˆ¶
- **similarity_threshold**: ç›¸ä¼¼åº¦é˜ˆå€¼è¿‡æ»¤
- **crop_region**: å›¾ç‰‡è£å‰ªåŒºåŸŸ
- **dataset_names**: æŒ‡å®šæœç´¢çš„æ•°æ®é›†

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨å¿…è¦æœåŠ¡

```bash
# 1. å¯åŠ¨RedisæœåŠ¡ (Windows)
redis-server

# 2. å¯åŠ¨è®¡ç®—ç«¯æœåŠ¡
cd backend_new/compute_server
python compute_server_fixed.py

# 3. å¯åŠ¨åç«¯æœåŠ¡
cd backend_new
python run.py
```

### 2. æ„å»ºç´¢å¼• (å¿…é¡»å…ˆå®Œæˆ)

åœ¨ä½¿ç”¨æœç´¢åŠŸèƒ½å‰ï¼Œéœ€è¦å…ˆä¸ºæ•°æ®é›†æ„å»ºç´¢å¼•ï¼š

- æ–¹æ³•1: ä½¿ç”¨å‰ç«¯ç•Œé¢çš„"ç´¢å¼•æ„å»º"åŠŸèƒ½
- æ–¹æ³•2: ä½¿ç”¨APIè°ƒç”¨ `POST /api/build_index`

### 3. æµ‹è¯•æœç´¢åŠŸèƒ½

```bash
# è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
python test_search_function.py

# æˆ–æ‰‹åŠ¨æµ‹è¯•
curl -X POST http://localhost:5000/api/search \
  -F "query_img=@test_image.jpg" \
  -F "dataset_names[]=1" \
  -F "dataset_names[]=2" \
  -F "top_k=10" \
  -F "similarity_threshold=50.0"
```

## ğŸ“Š APIä½¿ç”¨ç¤ºä¾‹

### è¯·æ±‚ç¤ºä¾‹ (JavaScript)
```javascript
const formData = new FormData();
formData.append('query_img', fileInput.files[0]);
formData.append('dataset_names[]', '1');
formData.append('dataset_names[]', '2');
formData.append('top_k', 10);
formData.append('similarity_threshold', 50.0);

// å¯é€‰çš„è£å‰ªå‚æ•°
formData.append('crop_x', 100);
formData.append('crop_y', 100);
formData.append('crop_w', 200);
formData.append('crop_h', 200);

fetch('/api/search', {
    method: 'POST',
    body: formData
})
.then(response => response.json())
.then(data => console.log(data));
```

### å“åº”ç¤ºä¾‹
```json
{
  "success": true,
  "results": [
    {
      "image_id": 123,
      "image_path": "/path/to/image.jpg",
      "img_url": "/show_image/datasets/1/image.jpg",
      "fname": "image.jpg",
      "similarity": 95.67,
      "distance": 0.0433,
      "dataset": "dataset1",
      "dataset_id": 1,
      "rank": 1,
      "file_size": 156789,
      "created_at": "2025-06-25T10:00:00"
    }
  ],
  "total_found": 5,
  "search_params": {
    "crop_region": {"x": 100, "y": 100, "width": 200, "height": 200},
    "datasets": ["1", "2"],
    "top_k": 10,
    "similarity_threshold": 50.0
  },
  "query_info": {
    "original_filename": "query.jpg",
    "query_time": "2025-06-25T15:44:36"
  }
}
```

## ğŸ”§ æŠ€æœ¯æ¶æ„

### ä¾èµ–å…³ç³»
```
search_routes.py
â”œâ”€â”€ _index_interface.py (FAISSç´¢å¼•ç®¡ç†)
â”œâ”€â”€ _database_interface.py (æ•°æ®åº“æŸ¥è¯¢)
â”œâ”€â”€ redis_client/ (ç‰¹å¾æå–é€šä¿¡)
â””â”€â”€ PIL (å›¾ç‰‡å¤„ç†)
```

### æœç´¢æµç¨‹
1. **æ–‡ä»¶éªŒè¯**: æ£€æŸ¥ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶æ ¼å¼
2. **å‚æ•°è§£æ**: è§£ææœç´¢å‚æ•°å’Œè£å‰ªåŒºåŸŸ
3. **å›¾ç‰‡é¢„å¤„ç†**: ä¿å­˜ä¸´æ—¶æ–‡ä»¶ï¼Œæ‰§è¡Œè£å‰ª(å¦‚éœ€è¦)
4. **ç‰¹å¾æå–**: é€šè¿‡Redisè°ƒç”¨è®¡ç®—ç«¯æå–ç‰¹å¾å‘é‡
5. **ç´¢å¼•æœç´¢**: ä½¿ç”¨FAISSç´¢å¼•è¿›è¡Œç›¸ä¼¼åº¦æœç´¢
6. **ç»“æœå¤„ç†**: åˆå¹¶å¤šæ•°æ®é›†ç»“æœï¼ŒæŒ‰ç›¸ä¼¼åº¦æ’åº
7. **ä¿¡æ¯è¡¥å……**: ä»æ•°æ®åº“è·å–å›¾ç‰‡è¯¦ç»†ä¿¡æ¯
8. **å“åº”è¿”å›**: è¿”å›æ ¼å¼åŒ–çš„æœç´¢ç»“æœ

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **"Rediså®¢æˆ·ç«¯ä¸å¯ç”¨"**
   - ç¡®ä¿RedisæœåŠ¡æ­£åœ¨è¿è¡Œ
   - æ£€æŸ¥Redisè¿æ¥é…ç½®

2. **"ç‰¹å¾æå–å¤±è´¥"**
   - ç¡®ä¿è®¡ç®—ç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ
   - æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶æ˜¯å¦æŸå

3. **"ç´¢å¼•æ–‡ä»¶ä¸å­˜åœ¨"**
   - å…ˆä¸ºç›¸å…³æ•°æ®é›†æ„å»ºç´¢å¼•
   - æ£€æŸ¥ç´¢å¼•æ–‡ä»¶è·¯å¾„

4. **"æ•°æ®é›†ä¸å­˜åœ¨"**
   - ç¡®ä¿æ•°æ®é›†å·²åœ¨æ•°æ®åº“ä¸­åˆ›å»º
   - æ£€æŸ¥æ•°æ®é›†åç§°æ˜¯å¦æ­£ç¡®

### è°ƒè¯•æ–¹æ³•

1. **æŸ¥çœ‹æ—¥å¿—**
   ```bash
   tail -f backend_new/futu_backend.log
   ```

2. **æ£€æŸ¥æœåŠ¡çŠ¶æ€**
   ```bash
   # æ£€æŸ¥åç«¯æœåŠ¡
   curl http://localhost:5000/api/datasets
   
   # æ£€æŸ¥Redisè¿æ¥
   redis-cli ping
   ```

3. **è¿è¡Œæµ‹è¯•è„šæœ¬**
   ```bash
   python test_search_function.py
   ```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æœç´¢æ€§èƒ½
- ç´¢å¼•å™¨ç¼“å­˜: é¿å…é‡å¤åˆ›å»ºç´¢å¼•å™¨å¯¹è±¡
- å¹¶è¡Œæœç´¢: æ”¯æŒå¤šæ•°æ®é›†å¹¶è¡ŒæŸ¥è¯¢
- ç»“æœè¿‡æ»¤: ç›¸ä¼¼åº¦é˜ˆå€¼é¢„è¿‡æ»¤

### å†…å­˜ç®¡ç†
- ä¸´æ—¶æ–‡ä»¶è‡ªåŠ¨æ¸…ç†
- Redisä»»åŠ¡ç»“æœåŠæ—¶åˆ é™¤
- ç‰¹å¾å‘é‡é«˜æ•ˆå¤„ç†

## ğŸ¯ ä¸‹ä¸€æ­¥æ‰©å±•

å¯èƒ½çš„åŠŸèƒ½æ‰©å±•ï¼š
- æ‰¹é‡å›¾ç‰‡æœç´¢
- æœç´¢ç»“æœç¼“å­˜
- æœç´¢å†å²è®°å½•
- é«˜çº§ç›¸ä¼¼åº¦ç®—æ³•
- å›¾ç‰‡å…ƒæ•°æ®æœç´¢

ç°åœ¨å›¾ç‰‡æœç´¢åŠŸèƒ½å·²ç»å®Œå…¨é‡å†™å¹¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼ğŸš€
